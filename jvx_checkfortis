#!/bin/bash
######################################
# Author: Percio Andrade
# Version: 9.0
# Info: Check if domains point to Fortis IPs with progress
######################################

# Lista de IPs da Fortis (ajuste aqui os IPs corretos)
FORTIS_IPS=("148.113.217.151")

# Arquivo com a lista de domínios
DOMAINS_FILE="${DOMAINS_FILE:-dominio-fortis.txt}"

# Arrays para armazenar resultados
declare -a OK
declare -a NOK

# Função para verificar se IP está na lista da Fortis
is_fortis_ip() {
    local ip=$1
    for fip in "${FORTIS_IPS[@]}"; do
        [[ "$ip" == "$fip" ]] && return 0
    done
    return 1
}

# Conta total de domínios
TOTAL=$(grep -cve '^\s*$' "$DOMAINS_FILE")
COUNT=0

echo "Iniciando verificação de domínios ($TOTAL domínios)..."

# Processa cada domínio
while read -r domain; do
    [[ -z "$domain" ]] && continue
    COUNT=$((COUNT + 1))

    # Barra de progresso
    PERC=$((COUNT * 100 / TOTAL))
    printf "\rProgresso: [%-50s] %d%%" $(printf "%0.s=" $(seq 1 $((PERC/2)))) "$PERC"

    # Captura IPs do domínio com timeout curto
    readarray -t ip_list < <(dig +time=2 +tries=1 A +short "$domain" @8.8.8.8 | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$')

    if [[ ${#ip_list[@]} -eq 0 ]]; then
        NOK+=("$domain | SEM IP")
        continue
    fi

    matched=false
    for ip in "${ip_list[@]}"; do
        if is_fortis_ip "$ip"; then
            OK+=("$domain | $ip")
            matched=true
        fi
    done

    if [[ $matched == false ]]; then
        for ip in "${ip_list[@]}"; do
            NOK+=("$domain | $ip")
        done
    fi
done < "$DOMAINS_FILE"

# Quebra de linha após progresso
echo -e "\n\nVerificação concluída!\n"

# Exibe resultado no terminal
echo "=============================="
echo "Domínios apontando para o Fortis"
echo "Dominio | IP"
for item in "${OK[@]}"; do
    echo "$item"
done

echo
echo "=============================="
echo "Domínios que NÃO apontam para o Fortis"
echo "Dominio | IP"
for item in "${NOK[@]}"; do
    echo "$item"
done

# Exporta CSV
CSV_OK="fortis.csv"
CSV_NOK="not-fortis.csv"

echo "Dominio;IP" > "$CSV_OK"
for item in "${OK[@]}"; do
    echo "$item" | sed 's/ | /;/' >> "$CSV_OK"
done

echo "Dominio;IP" > "$CSV_NOK"
for item in "${NOK[@]}"; do
    echo "$item" | sed 's/ | /;/' >> "$CSV_NOK"
done

echo
echo "CSV gerado:"
echo " - $CSV_OK"
echo " - $CSV_NOK"
