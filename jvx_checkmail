#!/bin/bash
######################################
# Author: Percio Andrade
# Version: 7.0
# Info: Check if email exists using swaks (SMTP RCPT test)
######################################

# Fun√ß√£o de ajuda
usage() {
    echo "Uso: $0 -e <email-origem> -d <destino@dominio> [-s servidorSMTP]"
    echo ""
    echo "  -e   Endere√ßo de email de origem (ex: percio@joinvix.com.br)"
    echo "  -d   Endere√ßo de email de destino a verificar"
    echo "  -s   (opcional) Servidor SMTP/MX a usar no teste"
    exit 1
}

# L√™ par√¢metros
while getopts "e:d:s:" opt; do
    case $opt in
        e) EMAIL_FROM=$OPTARG ;;
        d) EMAIL_TO=$OPTARG ;;
        s) SMTP_SERVER=$OPTARG ;;
        *) usage ;;
    esac
done

# Verifica obrigat√≥rios
[[ -z "$EMAIL_FROM" || -z "$EMAIL_TO" ]] && usage

# Se servidor n√£o for passado, resolve via MX
if [[ -z "$SMTP_SERVER" ]]; then
    DOMAIN=$(echo "$EMAIL_TO" | cut -d "@" -f2)
    SMTP_SERVER=$(host -t MX "$DOMAIN" | awk '{print $7}' | head -1)
    if [[ -z "$SMTP_SERVER" ]]; then
        echo "‚ùå N√£o foi poss√≠vel resolver MX para $DOMAIN"
        exit 1
    fi
fi

echo -e "\nüîé Verificando $EMAIL_TO via $SMTP_SERVER (MAIL FROM: $EMAIL_FROM)...\n"

# Executa swaks e captura a sa√≠da
RESULTS=$(swaks --to "$EMAIL_TO" --from "$EMAIL_FROM" --server "$SMTP_SERVER" --quit-after RCPT 2>/dev/null)

# Extrai o c√≥digo SMTP da resposta RCPT TO de forma confi√°vel
RCPT_LINE=$(echo "$RESULTS" | grep -Eo "([245][0-9]{2}) .*OK|([245][0-9]{2}) .*User unknown|([245][0-9]{2}) .*Recipient" | tail -1)

# Interpreta c√≥digo SMTP
if [[ $RCPT_LINE == 250* ]]; then
    echo "‚úÖ Email $EMAIL_TO EXISTE e foi aceito pelo servidor ($RCPT_LINE)"
elif [[ $RCPT_LINE == 550* || $RCPT_LINE == 551* || $RCPT_LINE == 553* || $RCPT_LINE == 554* ]]; then
    echo "‚ùå Email $EMAIL_TO N√ÉO existe ou foi rejeitado ($RCPT_LINE)"
elif [[ $RCPT_LINE == 451* || $RCPT_LINE == 452* ]]; then
    echo "‚ö†Ô∏è Resposta TEMPOR√ÅRIA do servidor ($RCPT_LINE) ‚Äî tente novamente mais tarde"
else
    echo "‚ùì N√£o foi poss√≠vel determinar. Resposta completa do servidor:"
    echo "$RESULTS"
fi
